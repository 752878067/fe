# 作用域 Scope



In a programming environment, the global scope is the scope that contains, and is visible in, all other scopes.
In client-side JavaScript, the global scope is generally the web page inside which all the code is being executed.

## 全局作用域 Global Scope
编程环境的中全局作用域是指**包含**且对其他任何作用域可见的作用域。

客户端 JavaScript 定义在全局作用域的值可以在任何地方被访问。
```javascript
var lyrics = '哟哟！';  // 全局变量

function qkn() {
  lyrics += '切';
  return kn();
  
  function kn() {
    lyrics += '克';
    return nao();
    
    function nao() {
      lyrics += '闹！';
      return lyrics;
    }
  }
}
```
```javascript
> qkn()
→ 哟哟！切克闹！
```

### 函数作用域 Function Scope
每个函数会创建一个新的函数作用域，在其中定义的值仅在该作用域可见。
```javascript
var lyrics = '哟哟！切克闹！';

function xq() {
  var lyrics = '';
  hands();
  steps();
  watch();
  return lyrics;
  
  function hands() { lyrics += '手牵手 '; }
  function steps() { lyrics += '一步两步三步四步 '; }
  function watch() { lyrics += '望着天'; }
}
```
```javascript
> xq()
→ "手牵手 一步两步三步四步 望着天"

> lyrics
→ "哟哟！切克闹！"
```

### 块级作用域 Block Scope
`ES6` 为 JavaScript 新增了块级作用域。

`ES6` 之前没有块级作用域，没有 `let` 或 `const`，只有全局作用域和函数作用域以及 `var`。

为什么以下程序不能正确运行？
```javascript
(function() {
  // 按照 tasks 的顺序和等待时间 wait 执行任务，程序报错。
  var tasks = [
    { name: '出场 😀', wait: 2 },
    { name: '隐身 🤡', wait: 3 },
    { name: '放大 😎', wait: 5 }
  ];
  for (var i = 0; i < tasks.length; i++) {
    setTimeout(function() {
      console.log('执行任务 ' + tasks[i].name);
    }, tasks[i].wait * 1000);
  }
  console.log(i)  // i 在整个函数作用域内有效
})();
```
利用 IIFE 新建函数作用域解决问题。
```javascript
(function() {
  // 按照 tasks 的顺序和等待时间 wait 执行任务，正确运行。
  var tasks = [
    { name: '出场 😀', wait: 2 },
    { name: '隐身 🤡', wait: 3 },
    { name: '放大 😎', wait: 5 }
  ];
  for (var i = 0; i < tasks.length; i++) {
    (function(i) {
       setTimeout(function() {
         console.log('执行任务 ' + tasks[i].name);
       }, tasks[i].wait * 1000);
    })(i);
  }
  console.log(i)  // i 在整个函数作用域内有效
})();
```
使用 `let` 简化进一步代码
```javascript
(function() {
  // 按照 tasks 的顺序和等待时间 wait 执行任务，正确运行。
  var tasks = [
    { name: '出场 😀', wait: 2 },
    { name: '隐身 🤡', wait: 3 },
    { name: '放大 😎', wait: 5 }
  ];
  for (let i = 0; i < tasks.length; i++) {
    setTimeout(function() {
      console.log('执行任务 ' + tasks[i].name);
    }, tasks[i].wait * 1000);
  }
  // console.log(i) 会报错，i 仅在代码块内有效。
})();
```

#### `{}` 替代 IIFE
⚠️ 以下代码仅作演示用途，为保证代码的可运行性，请使用 IIFE。
```javascript
{
  let keyframes = [
    { opacity: 1, transform: 'translateY(-180px)' }, 
    { opacity: 1, transform: 'translateY(0)' }
  ];
  let options = {
    duration: 600,
    easing: 'cubic-bezier(0.565,1.65,0.765,0.88)',
  };
  document.body.animate(keyframes, options);
}
```

## 参考链接
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/let
* https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Grammar_and_types#Variable_scope
